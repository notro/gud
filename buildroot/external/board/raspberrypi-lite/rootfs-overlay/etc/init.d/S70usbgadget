#!/bin/sh

# USB Display Gadget

. /etc/os-release

HW=$(cat /proc/cpuinfo | grep ^Hardware | cut -d":" -f2 | tr -d '[:space:]')
SN=$(cat /proc/cpuinfo | grep ^Serial | cut -d":" -f2 | tr -d '[:space:]')

MANUFACTURER="Raspberry Pi"

if [ "$HW" = "BCM2835" ]; then
	PRODUCT="Raspberry Pi Zero Display Gadget Lite"
	MAXPOWER=120 # mA
elif [ "$HW" = "BCM2711" ]; then
	PRODUCT="Raspberry Pi 4 Display Gadget Lite"
	MAXPOWER=500 # mA
else
	PRODUCT="$HW Display Gadget Lite"
	MAXPOWER=500 # mA
fi

UDC=$(ls /sys/class/udc | cut -f1 | grep -v usbip | head -n1)

if grep -q 'drm_dev=' /proc/cmdline; then
	drm_dev=$(cat /proc/cmdline | xargs -n1 | grep 'drm_dev=' | cut -d'=' -f2)
else
	drm_dev=0
fi

backlight_dev=
cd /sys/class/backlight/
for d in * ; do
	if [ -d "$d" ] && [ $(cat "$d/max_brightness") -gt 1 ]; then
		backlight_dev="$d"
		break
	fi
done

start() {
	cd /sys/kernel/config/usb_gadget
	mkdir g1
	cd g1

	echo 0x1d50 > idVendor
	echo 0x614d > idProduct

	if [ -n "$GUD_VERSION_BCD" ]; then
		echo "$GUD_VERSION_BCD" > bcdDevice
	fi

	mkdir strings/0x409
	echo "$MANUFACTURER" > strings/0x409/manufacturer
	echo "$PRODUCT" > strings/0x409/product
	echo "$SN" > strings/0x409/serialnumber

	mkdir configs/c.1
	echo "$MAXPOWER" > configs/c.1/MaxPower

	mkdir functions/gud.0
	echo "$drm_dev" > functions/gud.0/drm_dev
	if [ -n "$backlight_dev" ]; then
		echo "$backlight_dev" > functions/gud.0/backlight_dev
	fi
	if grep -q nocompression /proc/cmdline; then
		echo 0 > functions/gud.0/compression
	fi
	if grep -q rgb565 /proc/cmdline; then
		# GUD_PIXEL_FORMAT_RGB565
		printf "@" > functions/gud.0/formats
	fi
	if grep -q 'connectors=' /proc/cmdline; then
		cat /proc/cmdline | xargs -n1 | grep 'connectors=' | cut -d'=' -f2 > functions/gud.0/connectors
	fi
	ln -s functions/gud.0/ configs/c.1/

	if [ -x /usr/bin/hidg-touch ]; then
		if grep -q 'touch_dev=no' /proc/cmdline; then
			touch=
		elif grep -q 'touch_dev=' /proc/cmdline; then
			num=$(cat /proc/cmdline | xargs -n1 | grep 'touch_dev=' | cut -d'=' -f2)
			touch="/dev/input/event$num"
		else
			touch=$(/usr/bin/hidg-touch --find)
		fi

		if [ -n "$touch" ]; then
			mkdir functions/hid.0
			echo 1 > functions/hid.0/protocol
			echo 1 > functions/hid.0/subclass
			/usr/bin/hidg-touch --length "$touch" > functions/hid.0/report_length
			/usr/bin/hidg-touch --desc "$touch" > functions/hid.0/report_desc

			ln -s functions/hid.0/ configs/c.1/
		fi
	fi

	echo "$UDC" > UDC

	[ -n "$touch" ] && /usr/bin/hidg-touch "$touch" /dev/hidg0 &
}

stop() {
	cd /sys/kernel/config/usb_gadget
	if [ -d "g1" ]; then
		cd g1
		echo > UDC 2> /dev/null
		find configs/c.1/ -maxdepth 1 -type l -exec rm -f {} +
		rmdir configs/c.1

		if [ -e functions/hid.0 ]; then
			pkill -f hidg-touch
			rmdir functions/hid.0
		fi
		[ -e functions/gud.0 ] && rmdir functions/gud.0

		rmdir strings/0x409
		cd ..
		rmdir g1
	fi
}

case "$1" in
  start)
	start;;
  stop)
	stop;;
  *)
	echo "Usage: $0 {start|stop}"
	exit 1
esac

exit $?
